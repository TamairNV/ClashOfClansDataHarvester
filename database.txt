-- 1. CLAN Table
CREATE TABLE IF NOT EXISTS Clan (
    tag VARCHAR(15) PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    level INT NOT NULL
) ENGINE=InnoDB;

---------------------------------------------------

-- 2. PLAYER Table (Just the static ID/Name/Current Clan Link)
CREATE TABLE IF NOT EXISTS Player (
    playerTag VARCHAR(15) PRIMARY KEY,
    clanTag VARCHAR(15),
    name VARCHAR(50) NOT NULL,

    FOREIGN KEY (clanTag) REFERENCES Clan(tag)
) ENGINE=InnoDB;

---------------------------------------------------

-- 3. CLANWAR Table (The War Event, including CWL grouping)
CREATE TABLE IF NOT EXISTS ClanWar (
    warID INT AUTO_INCREMENT PRIMARY KEY,
    clanTag1 VARCHAR(15) NOT NULL,
    clanTag2 VARCHAR(15) NOT NULL,
    state VARCHAR(20) NOT NULL, -- e.g., "inWar", "ended"
    teamSize INT NOT NULL,
    startTime DATETIME NOT NULL,
    endTime DATETIME,
    warType VARCHAR(20) NOT NULL, -- e.g., "Standard", "CWL", "Friendly"
    leagueGroupId VARCHAR(50), -- To link the 7 wars of a CWL season
    league VARCHAR(50),

    FOREIGN KEY (clanTag1) REFERENCES Clan(tag),
    FOREIGN KEY (clanTag2) REFERENCES Clan(tag)
) ENGINE=InnoDB;

---------------------------------------------------

-- 4. WARRESULTS Table (Two rows per war: one for each clan)
CREATE TABLE IF NOT EXISTS WarResults (
    warID INT,
    clanTag VARCHAR(15), -- The clan whose results this row represents
    totalDestruction DECIMAL(5, 2) NOT NULL, -- Percentage (e.g., 98.75)
    totalStars INT NOT NULL,
    result VARCHAR(10) NOT NULL, -- e.g., "win", "loss", "tie"

    PRIMARY KEY (warID, clanTag),
    FOREIGN KEY (warID) REFERENCES ClanWar(warID),
    FOREIGN KEY (clanTag) REFERENCES Clan(tag)
) ENGINE=InnoDB;

---------------------------------------------------

-- 5. WARPLAYER Table (Roster for a specific war, including opponent players)
CREATE TABLE IF NOT EXISTS WarPlayer (
    warID INT,
    playerTag VARCHAR(15),
    mapPosition INT NOT NULL,
    townHallLevel INT NOT NULL,
    name VARCHAR(50) NOT NULL, -- Denormalized name for historical accuracy

    PRIMARY KEY (warID, playerTag),
    FOREIGN KEY (warID) REFERENCES ClanWar(warID),
    FOREIGN KEY (playerTag) REFERENCES Player(playerTag)
) ENGINE=InnoDB;

---------------------------------------------------

-- 6. ATTACK Table (The actual war hits)
CREATE TABLE IF NOT EXISTS Attack (
    warID INT,
    attackerTag VARCHAR(15),
    defenderTag VARCHAR(15),
    stars INT NOT NULL,
    destruction DECIMAL(5, 2) NOT NULL,
    startTime DATETIME NOT NULL, -- When the attack started
    duration INT NOT NULL, -- Duration in seconds

    -- Composite primary key (e.g., player #1 attack 1, player #1 attack 2)
    -- Using attackerTag + startTime (assuming two attacks are never simultaneous)
    PRIMARY KEY (warID, attackerTag, startTime),

    FOREIGN KEY (warID, attackerTag) REFERENCES WarPlayer(warID, playerTag),
    FOREIGN KEY (warID, defenderTag) REFERENCES WarPlayer(warID, playerTag)
) ENGINE=InnoDB;

---------------------------------------------------

-- 7. LEAGUE Table (For storing league names and icons, if needed)
CREATE TABLE IF NOT EXISTS League (
    name VARCHAR(50) PRIMARY KEY,
    iconURL VARCHAR(255)
) ENGINE=InnoDB;

---------------------------------------------------

-- 8. PLAYERSNAPSHOT Table (The historical tracker for player stats)
CREATE TABLE IF NOT EXISTS PlayerSnapshot (
    playerTag VARCHAR(15),
    time DATETIME, -- The timestamp of this snapshot
    clanTag VARCHAR(15),
    townHallLevel INT,
    exLevel INT,
    warStars INT,
    builderHallLevel INT,
    builderBaseTrophies INT,
    role VARCHAR(20), -- e.g., "member", "coLeader"
    warPreference VARCHAR(10), -- e.g., "in", "out"
    donations INT,
    donationsRecieved INT,
    clanCapitalContributions INT,
    league VARCHAR(50), -- Foreign key to League table

    PRIMARY KEY (playerTag, time),
    FOREIGN KEY (playerTag) REFERENCES Player(playerTag),
    FOREIGN KEY (clanTag) REFERENCES Clan(tag),
    FOREIGN KEY (league) REFERENCES League(name)
) ENGINE=InnoDB;

---------------------------------------------------

-- 9. ACTIVITYSNAPSHOT Table (Minimal log for activity check)
CREATE TABLE IF NOT EXISTS ActivitySnapshot (
    playerTag VARCHAR(15),
    time DATETIME,

    PRIMARY KEY (playerTag, time),
    FOREIGN KEY (playerTag) REFERENCES Player(playerTag)
) ENGINE=InnoDB;

ALTER TABLE WarPlayer
ADD COLUMN clanTag VARCHAR(15);

ALTER TABLE WarPlayer
ADD CONSTRAINT fk_warplayer_clan
FOREIGN KEY (clanTag) REFERENCES Clan(tag);